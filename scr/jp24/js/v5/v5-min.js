import{apis}from"../../../config/apis.js";import DOMAINS from"../../../config/domains.js";const timeFirstRenderPage=new Date,regexPhone=/^(0|\+84)(9[0-9]|3[2-9]|7[06-9]|5[6-9]|8[1-9]|2[0-9])\d{7}$/;let parentUrl=window.location.href.indexOf("split=")>-1?window.location.href.split("split=")[1]:window.location.href,elInputs=document.querySelectorAll(".input-cache input"),form=document.querySelector(".form-submit--skycom form"),overlay=document.getElementById("overlay"),buttonSubmit=document.getElementById("btn-submit"),encodeName="",encodePhone="",isKeyboardOpen=0,Count_na_keyboard=0,Count_na_delete_keyboard=[],Is_open_na_keyboard=null,Action_na_time=0,Count_po_keyboard=0,Action_po_time=0,Action_po_to_submit=0,Is_open_po_keyboard=null,Count_po_delete_keyboard=[],Action_time=0,Action_form_time=0,Skl_vistorID=null,Detect_bot=!1,adsClickId="",third_id=0,Count_3rd_id=1,Change_3rd_id=!1,Fe_check=!1,Fe_note="",Sceensize="",Touch_pixel=[],Is_device_motion_change=null,Count_device_motion=0;function detectDevice(){let e=!1,t=!1;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(t=!0,/iPhone|iPad|iPod/i.test(navigator.userAgent)&&(e=!0)),{isIOS:e,isMobile:t}}function listenerKeyboardOpen(){return window.innerWidth<768&&window.screen.height-280>window.visualViewport.height&&(isKeyboardOpen=!0),isKeyboardOpen}function getRandomInt(e){return Math.floor(Math.random()*e)}function textEnpty(e){return" ".repeat(e)}function encryptionIDFileds(){elInputs.forEach(((e,t)=>{const n=(Math.random()+1).toString(36).slice(2,7);0===t&&(encodeName=n),1===t&&(encodePhone=n);let o=e.getAttribute("placeholder");o+=textEnpty(100)+n+"-"+n+textEnpty(getRandomInt(20))+n+"-"+n,e.setAttribute("id",n),e.setAttribute("name",n),e.setAttribute("placeholder",o)}))}encryptionIDFileds();const fieldName=document.getElementById(encodeName),fieldPhone=document.getElementById(encodePhone);function disableEnterSubmit(){document.addEventListener("keydown",(e=>{13!==e.keyCode&&9!=e.keyCode||e.preventDefault()}))}function disableCopy(){fieldName.onpaste=function(e){e.preventDefault()},fieldPhone.onpaste=function(e){e.preventDefault()}}function checkTouchSupport(){window.addEventListener("touchstart",(function(e){for(let t=0;t<e.touches.length;t++){const n=e.touches[t].screenX.toFixed(2),o=e.touches[t].screenY.toFixed(2);Touch_pixel.push(`${n}_${o}`)}}))}function detectAdsId(){const e=parentUrl.split("&"),t=e?.find((e=>e.indexOf("utm_source")>-1));t&&(t.indexOf("facebook")>-1&&(adsClickId=e.find((e=>e.indexOf("fbclid")>-1))),(t.indexOf("youtube")>-1||t.indexOf("google")>-1)&&(adsClickId=e.find((e=>e.indexOf("gclid")>-1))),t.indexOf("tiktok")>-1&&(adsClickId=e.find((e=>e.indexOf("ttclid")>-1))),third_id=adsClickId?.split("=")[1])}function countViewPage(){const e="3rd_id",t="Count_3rd_id";third_id&&!localStorage.getItem(e)&&localStorage.setItem(e,third_id),third_id&&(localStorage.getItem(e)!=third_id?Change_3rd_id=!0:localStorage.getItem(t)?localStorage.setItem(t,Number(localStorage.getItem(t))+1):localStorage.setItem(t,Count_3rd_id))}function listenPhoneValidate(){fieldPhone.addEventListener("input",(e=>{regexPhone.test(e.target.value)&&syncToSheetValidate({phone:e.target.value,link:parentUrl})}))}function handleCountNameTyping(){var e=0,t=0;fieldName.addEventListener("input",(function(e){Count_na_keyboard++})),fieldName.addEventListener("keydown",(function(n){8===n.keyCode&&(e++,Count_na_delete_keyboard.push(`${e}-${t}`),t=1)})),fieldName.addEventListener("mouseup",(function(e){0==(t=e.target.selectionEnd-e.target.selectionStart)&&(t=1)}))}function handleCountPhoneTyping(){var e=0,t=0;fieldPhone.addEventListener("input",(function(e){Count_po_keyboard+=1})),fieldPhone.addEventListener("keydown",(function(n){8===n.keyCode&&(e++,Count_po_delete_keyboard.push(`${e}-${t}`),t=1)})),fieldPhone.addEventListener("mouseup",(function(e){0==(t=e.target.selectionEnd-e.target.selectionStart)&&(t=1)}))}disableEnterSubmit(),disableCopy(),checkTouchSupport(),countViewPage(),handleCountNameTyping(),handleCountPhoneTyping();var timeNaIn=0,timePoIn=0,timeNaOut=0,timePoOut=0,timeAdIn=0,timeAdOut=0;function setTimer(){fieldName?.addEventListener("click",(function(e){timeNaIn||(timeNaIn=new Date),window.visualViewport.addEventListener("resize",listenerKeyboardOpen)})),fieldName?.addEventListener("focusout",(function(e){timeNaOut=new Date})),fieldPhone?.addEventListener("click",(function(e){timePoIn||(timePoIn=new Date),window.visualViewport.addEventListener("resize",listenerKeyboardOpen)})),fieldPhone?.addEventListener("focusout",(function(e){timePoOut=new Date}))}function inputTiming(){return Action_na_time=Math.abs(timeNaOut-timeNaIn)/1e3,Action_po_time=Math.abs(timePoOut-timePoIn)/1e3,Action_po_to_submit=Math.abs((+new Date-+timePoOut)/1e3),Action_time=Math.abs(new Date-timeFirstRenderPage)/1e3,Action_form_time=timeNaIn<timePoIn?Math.abs(new Date-timeNaIn)/1e3:Math.abs(new Date-timePoIn)/1e3,{Action_po_time:Action_po_time,Action_na_time:Action_na_time,Action_po_to_submit:Action_po_to_submit,Action_time:Action_time,Action_form_time:Action_form_time}}async function syncToSheetValidate({phone:e,link:t}){t=t.indexOf("&")>-1?t.replaceAll("&","_SKYCOM_"):t;apis.jp24.urlSyncGoogleSheetSpam;await fetch(`${apis.jp24.urlSyncGoogleSheetSpam}?phone=${e}&link=${t}&SHEET_NAME=SDTValidate`,{method:"GET",mode:"no-cors",headers:{"Content-Type":"application/json"},redirect:"follow"})}async function syncToSheetServerFail({name:e,phone:t,ad_channel:n,ad_account:o,link:i,reasons:a}){i=i.indexOf("&")>-1?i.replaceAll("&","_SKYCOM_"):i,await fetch(`${apis.jp24.urlSyncGoogleSheetSpam}?time=${timeFirstRenderPage.toLocaleDateString()}-${timeFirstRenderPage.toLocaleTimeString()}&name=${e}&phone=${t}&utmSource=${n||""}&utmMedium=${o||""}&link=${i}&reasons=${a}&SHEET_NAME=ErrorServer`,{method:"GET",mode:"no-cors",headers:{"Content-Type":"application/json"},redirect:"follow"})}async function syncToSheetDataSubmit({name:e,phone:t,ad_channel:n,ad_account:o,isSuspect:i,link:a,spam:d,reasons:c}){a=a.indexOf("&")>-1?a.replaceAll("&","_SKYCOM_"):a,await fetch(`${apis.jp24.urlSyncGoogleSheetSpam}?time=${timeFirstRenderPage.toLocaleDateString()}-${timeFirstRenderPage.toLocaleTimeString()}&name=${e}&phone=${t}&utmSource=${n||""}&utmMedium=${o||""}&isSuspect=${i}&link=${a}&spam=${d}&reasons=${c}&SHEET_NAME=TotalSDT`,{method:"GET",mode:"no-cors",headers:{"Content-Type":"application/json"},redirect:"follow"})}async function handlePostData({Ten1:e,Ten2:t,name:n,phone:o,Count_na_keyboard:i,Action_na_time:a,Is_open_na_keyboard:d,Count_na_delete_keyboard:c,Count_po_keyboard:r,Action_po_time:_,Action_po_to_submit:s,Is_open_po_keyboard:l,Count_po_delete_keyboard:u,Action_time:m,Action_form_time:p,Sceensize:h,Touch_pixel:f,Is_device_motion_change:b,Count_3rd_id:y,Change_3rd_id:g,Skl_vistorID:k,Detect_bot:S,Fe_check:v,Fe_note:C,Count_device_motion:I}){const A={Ten1:e,Ten2:t,name:n,phone:o,link:parentUrl,Count_na_keyboard:i,Action_na_time:a,Is_open_na_keyboard:d,Count_na_delete_keyboard:c,Count_po_keyboard:r,Action_po_time:_,Action_po_to_submit:s,Is_open_po_keyboard:l,Count_po_delete_keyboard:u,Action_time:m,Action_form_time:p,Sceensize:h,Touch_pixel:f,Is_device_motion_change:b,Count_3rd_id:y,Change_3rd_id:g,Skl_vistorID:k,Detect_bot:S,Fe_check:v,Fe_note:C,Count_device_motion:I};await fetch(apis.jp24.bareURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A)}).then((function(e){return e.json()})).then((async function(n){await syncToSheetDataSubmit({name:e,phone:t,link:parentUrl,spam:n.spam,isSuspect:n.suspect,reasons:n.reasons,ad_channel:n.ad_channel,ad_account:n.ad_account}),n.spam?window.parent.location.replace(`${apis.jp24.urlThankFake}?name=${e}&phone=${t}`):n.suspect?window.parent.location.replace(`${apis.jp24.urlConfirm}?lead_id=${n.lead_id}`):window.parent.location.replace(`${apis.jp24.urlThankReal}?name=${e}&phone=${t}`)})).catch((async function(n){await syncToSheetServerFail({name:e,phone:t,link:parentUrl,reason:n.message})}))}function validateForm(){const e=fieldPhone.value;let t=!0;return regexPhone.test(e)||(document.getElementById("errorMessage").innerText="Vui lòng nhập đúng số điện thoại",t=!1),t}function handleSubmit(){if(validateForm()){const{Action_na_time:e,Action_po_time:t,Action_po_to_submit:n,Action_time:o,Action_form_time:i}=inputTiming(),a=fieldName.value,d=fieldPhone.value,c=document.getElementById("ten2").value,r=document.getElementById("sdt2").value;Sceensize=`${window.screen.width} x ${window.screen.height}`,Count_3rd_id=localStorage.getItem("Count_3rd_id"),buttonSubmit.innerText="ĐANG XỬ LÝ!!!",buttonSubmit.parentElement.classList.add("disable"),overlay.classList.add("active"),handlePostData({Ten1:a,Ten2:d,name:c,phone:r,Count_na_keyboard:Count_na_keyboard,Action_na_time:e,Is_open_na_keyboard:Is_open_na_keyboard,Count_na_delete_keyboard:Count_na_delete_keyboard,Count_po_keyboard:Count_po_keyboard,Action_po_time:t,Action_po_to_submit:n,Is_open_po_keyboard:Is_open_po_keyboard,Count_po_delete_keyboard:Count_po_delete_keyboard,Action_time:o,Action_form_time:i,Sceensize:Sceensize,Touch_pixel:Touch_pixel,Is_device_motion_change:Is_device_motion_change,Count_3rd_id:Count_3rd_id,Change_3rd_id:Change_3rd_id,Skl_vistorID:Skl_vistorID,Detect_bot:Detect_bot,Fe_check:Fe_check,Fe_note:Fe_note,Count_device_motion:Count_device_motion})}}function handleEventMessage(e){var t=e.origin||e.originalEvent.origin;let n=!1;if(DOMAINS.forEach((e=>{t.indexOf(e)>-1&&(n=!0)})),n&&"object"==typeof e.data&&"skylink_event"==e.data.call){const t=JSON.parse(e.data.value);parentUrl=t.src,Is_device_motion_change=t.Is_device_motion_change,Count_device_motion=t.Count_device_motion,Skl_vistorID=t.Skl_vistorID,Detect_bot=t.Detect_bot,detectAdsId(),listenPhoneValidate()}}setTimer(),window.addEventListener("message",handleEventMessage),buttonSubmit.addEventListener("click",(function(e){Math.abs(new Date-timeFirstRenderPage)/1e3>10||""==fieldName.value.trim()&&""==fieldPhone.value.trim()&&(Fe_check=!0,Fe_note="nhấn submit quá nhiều lần (Action_time < 10s)")})),form.addEventListener("submit",(function(e){e.preventDefault(),handleSubmit()}));